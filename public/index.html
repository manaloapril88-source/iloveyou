const recordBtn = document.getElementById('recordBtn');
const status = document.getElementById('status');
const body = document.body;

// 1. Google STT Setup (Pakinig)
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = 'en-US'; // Pwedeng 'fil-PH' kung gusto mo mas accurate sa tagalog, but 'en-US' works too.
recognition.interimResults = false;

// 2. Google TTS Setup (Pananalita)
const synth = window.speechSynthesis;

recordBtn.addEventListener('click', () => {
    if (body.classList.contains('recording')) {
        recognition.stop();
    } else {
        recognition.start();
    }
});

recognition.onstart = () => {
    body.className = 'recording';
    status.textContent = "Alexatron is listening...";
};

recognition.onresult = async (event) => {
    const transcript = event.results[0][0].transcript;
    console.log("Narinig ni Alexatron:", transcript);
    
    // I-send ang text sa backend para mag-isip si Alexatron
    getAIResponse(transcript);
};

async function getAIResponse(text) {
    body.className = 'processing';
    status.textContent = "Alexatron is thinking...";

    try {
        const response = await fetch('/ask-alexatron', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
        });

        const data = await response.json();
        speak(data.reply);
    } catch (err) {
        console.error("Error:", err);
        resetUI();
    }
}

function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US'; // English voice
    utterance.rate = 1.0;     // Bilis ng pagsasalita
    
    utterance.onstart = () => {
        body.className = 'speaking';
        status.textContent = "Alexatron is speaking...";
    };

    utterance.onend = () => {
        resetUI();
    };

    synth.speak(utterance);
}

function resetUI() {
    body.className = '';
    status.textContent = "Tap to talk to Alexatron";
}
