<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alexatron AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; background: #1e293b; padding: 2.5rem; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); width: 90%; max-width: 400px; border: 1px solid #334155; }
        #recordBtn { width: 110px; height: 110px; border-radius: 50%; border: 3px solid #334155; background: #1e293b; color: #3b82f6; font-size: 2.5rem; cursor: pointer; transition: 0.4s; margin-bottom: 20px; outline: none; }
        #status { font-size: 1rem; color: #10b981; font-weight: 500; margin-bottom: 10px; }
        #preview { font-size: 0.85rem; color: #64748b; font-style: italic; }
        .recording #recordBtn { background: #ef4444; color: white; border-color: #ef4444; animation: pulse 1.5s infinite; }
        .speaking #recordBtn { background: #3b82f6; color: white; box-shadow: 0 0 30px #3b82f6; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="listening-wake">

    <div class="container">
        <h1 style="letter-spacing: 5px; color: #3b82f6;">ALEXATRON</h1>
        <button id="recordBtn"><i class="fas fa-microphone"></i></button>
        <div id="status">Click Mic to Start</div>
        <div id="preview">Waiting for command...</div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const body = document.body;

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        const synth = window.speechSynthesis;
        let isProcessing = false;

        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        function getTagalogVoice() {
            const voices = synth.getVoices();
            // Priority: Google Filipino -> Any Filipino Voice -> Microsoft Rizal/Honey
            return voices.find(v => v.lang.includes("PH") || v.lang.includes("fil") || v.name.includes("Filipino")) || voices[0];
        }

        recognition.onresult = (event) => {
            if (synth.speaking || isProcessing) return;
            let text = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                text += event.results[i][0].transcript;
            }
            preview.textContent = text;

            if (text.toLowerCase().includes("computer") || text.toLowerCase().includes("ai")) {
                startListening();
            }
        };

        function startListening() {
            isProcessing = true;
            body.className = "recording";
            status.textContent = "Listening...";
            // Auto-stop recording after 3 seconds of silence
            setTimeout(() => {
                if (preview.textContent.length > 2) {
                    sendToAI(preview.textContent);
                } else {
                    reset();
                }
            }, 3000);
        }

        async function sendToAI(msg) {
            status.textContent = "Thinking...";
            try {
                const res = await fetch('/ask-alexatron', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                speak(data.response);
            } catch (e) { reset(); }
        }

        function speak(text) {
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.voice = getTagalogVoice(); // ETO YUNG FORCE TAGALOG
            utter.lang = 'fil-PH';
            utter.rate = 1;
            
            utter.onstart = () => { body.className = "speaking"; status.textContent = text; };
            utter.onend = () => { isProcessing = false; reset(); };
            synth.speak(utter);
        }

        function reset() {
            isProcessing = false;
            body.className = "";
            status.textContent = 'Say "Computer"';
            try { recognition.start(); } catch(e) {}
        }

        recordBtn.onclick = () => { reset(); };
        window.onload = () => { synth.getVoices(); try { recognition.start(); } catch(e) {} };
    </script>
</body>
</html>
