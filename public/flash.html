<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alexatron Web Flasher</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      text-align: center; 
      padding: 2rem; 
      background: #f8f9fa; 
      color: #212529; 
    }
    h1 { color: #0d6efd; }
    button { 
      padding: 1rem 2.5rem; 
      margin: 1rem; 
      font-size: 1.3rem; 
      cursor: pointer; 
      border: none; 
      border-radius: 0.5rem; 
      color: white; 
    }
    #connect { background: #198754; }
    #flash { background: #fd7e14; }
    #status { 
      margin: 2rem auto; 
      max-width: 600px; 
      font-size: 1.2rem; 
      white-space: pre-wrap; 
      line-height: 1.6; 
    }
    progress { width: 70%; height: 24px; margin: 1rem auto; display: block; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Alexatron Web Flasher</h1>
  <p>Ikonekta ang ESP32-C3 mo sa USB. Kung hindi ma-detect, pindutin ang BOOT button habang iko-connect.</p>

  <button id="connect">Connect Device</button>
  <button id="flash" class="hidden">Flash Firmware from Server</button>

  <div id="status">Status: Handa na</div>
  <progress id="progress" value="0" max="100" class="hidden"></progress>

  <script type="module">
    import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.6/dist/web/index.js';

    const connectBtn = document.getElementById('connect');
    const flashBtn   = document.getElementById('flash');
    const status     = document.getElementById('status');
    const progress   = document.getElementById('progress');

    let device;
    let transport;
    let loader;

    connectBtn.onclick = async () => {
      try {
        status.textContent = 'Nagre-request ng serial port...';
        device = await navigator.serial.requestPort({ filters: [{ usbVendorId: 0x303a }] });
        transport = new Transport(device);
        loader = new ESPLoader(transport, console, false);

        status.textContent = 'Kinokonekta...';
        await loader.main_fn();
        const chipInfo = await loader.detectChip();
        status.textContent = `Nakonekta! Chip: ${chipInfo.chip_name}, MAC: ${chipInfo.mac}`;
        flashBtn.classList.remove('hidden');
      } catch (err) {
        status.textContent = `Error: ${err.message || err}`;
      }
    };

    flashBtn.onclick = async () => {
      if (!loader) {
        status.textContent = 'Kailangan munang i-connect ang device.';
        return;
      }

      status.textContent = 'Kinukuha ang firmware mula sa server...';
      progress.classList.remove('hidden');
      progress.value = 0;

      try {
        const firmwareUrl = '/firmware/alexatron.bin'; // â† automatic mula sa server mo
        const response = await fetch(firmwareUrl);
        if (!response.ok) throw new Error(`Hindi makita ang firmware (status ${response.status})`);

        const firmwareData = await response.arrayBuffer();
        status.textContent = 'Nag-e-erase at nagfa-flash... Huwag tanggalin ang USB!';

        await loader.write_flash({
          fileArray: [{ data: new Uint8Array(firmwareData), address: 0x0 }],
          reportProgress: (fileIndex, written, total) => {
            progress.value = Math.round((written / total) * 100);
          }
        });

        status.textContent = 'Tapos na ang pag-flash! Nagre-reboot ang device...';
        await loader.hard_reset();
      } catch (err) {
        status.textContent = `Pag-flash ay nabigo: ${err.message || err}`;
      } finally {
        progress.classList.add('hidden');
      }
    };
  </script>
</body>
</html>
